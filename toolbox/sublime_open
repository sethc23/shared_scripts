#!env zsh

date > /tmp/tmp_subl_open
# (from realpath man ...)
#
# -e, --canonicalize-existing
#        all components of the path must exist
#
# -m, --canonicalize-missing
#        no path components need exist or be a directory
#

_params="${@: 1:-1}"
_target=$(echo "${@: -1}"|sed -r 's/[ ]/\\ /g')

FPATH=$(realpath -e "$_target" 2> /dev/null)
FPATH=$(echo "$FPATH"|sed -r 's/[ ]/\\ /g')

test -e "$FPATH" || (echo "Unreadable target path: '"$_target"'" && exit 99)

SSH_CMD=
CMD_BASE="open -a \"Sublime Text\""

if [[ "$(uname -s)" != "Darwin" ]]; then
    SSH_CMD="ssh admin"
    FPATH="/Volumes/$USER/$FPATH"
fi

CMD="$(echo $SSH_CMD $CMD_BASE $FPATH)"
[[ -n $_params ]] && CMD="$CMD --args "$_params

echo "$CMD" >> /tmp/tmp_subl_open

eval $CMD
